(()=>{"use strict";var e,t={3607:(e,t,s)=>{s(5996),s(9520);const i=s(8838),o=s(3856),n=document.getElementById("view"),r=new i.Engine(n,!0),a=new o.default(r);a.init().then((()=>{r.runRenderLoop((()=>{a.update()}))}))},671:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0});const i=s(7872);t.default=class{static get characters(){return i.characters}static getCharacter(e){return i.characters.find((t=>t.id===e))}}},871:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0});const i=s(2557),o=s(320),n=s(4473),r=s(3120);class a extends r.default{constructor(e,t){super(e,t),this._direction=0,this.addComponent(new o.default(this,e.movement)),this.addComponent(new n.default(this,e.render)),this.addComponent(new i.default(this))}get direction(){return this._direction}set direction(e){this._direction=e}load(e){super.load(e),this._direction=e.direction}save(){let e=super.save();return e.direction=this._direction,e}get type(){return r.GameObjectType.Character}}t.default=a},2557:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0});const i=s(8629);class o extends i.default{constructor(e){super(e),this._groups={};const t=this.parent.getComponent(i.ComponentType.Movement);t&&(t.onMove=e=>{e<.2?this.play("idle"):this.play("run",e)})}play(e,t=1,s=!0){const i=this._groups[e];if(!i)return console.warn(`Animation group ${e} not found`),null;i!==this._currentGroup?(i.play(!0),s&&this._currentGroup&&this._currentGroup.stop(),this._currentGroup=i):i.speedRatio=t}get type(){return i.ComponentType.Animation}update(){}setGroups(e){e.forEach((e=>{this._groups[e.name]=e}))}}t.default=o},8629:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.ComponentType=void 0,function(e){e[e.Movement=0]="Movement",e[e.Render=1]="Render",e[e.Animation=2]="Animation"}(s||(s={})),t.ComponentType=s,t.default=class{constructor(e){this._parent=e}destroy(){this._parent=null}get parent(){return this._parent}}},320:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MovementInput=void 0;const i=s(5412),o=s(5176),n=s(8629);class r extends n.default{constructor(e,t){super(e),this.onMove=()=>{},this.input=new a,this._velocity=i.Vector2.Zero(),this._config=t}get type(){return n.ComponentType.Movement}update(){!1!==this._parent.level.isPassableTile(this._parent.position)?(this.updateMove(this.input),this.updateDirection()):console.warn("Character is not on passable tile")}updateMove(e){let t=e.axis;t.lengthSquared()>1&&t.normalize();let s=0!==t.lengthSquared()?t.scale(this._config.speed):i.Vector2.Zero();this._velocity=i.Vector2.Lerp(this._velocity,s,this._config.acceleration*o.default.TICK_DELTA_TIME);const n=this._velocity.clone().scale(o.default.TICK_DELTA_TIME),r=this._parent.level,a=this._parent.position.add(n);if(r.isPassableTile(a))this._parent.position=a;else{const e=n.length();this.findPassableTile(this._parent.position,a,e)}this.onMove(this._velocity.length()/this._config.speed)}findPassableTile(e,t,s){const i=t.subtract(e).normalize(),o=t.subtract(e).length();for(let t=0;t<o;t+=s){const s=e.add(i.scale(t));if(this._parent.level.isPassableTile(s))return s}return null}updateDirection(){let e=this._velocity;e.lengthSquared()>1&&(e=e.clone().normalize());let t=Math.atan2(e.y,e.x);this.character.direction=t+Math.PI/2}get character(){return this._parent}}class a{constructor(){this.axis=i.Vector2.Zero()}}t.MovementInput=a,t.default=r},4473:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0});const i=s(5863),o=s(3063),n=s(8629);class r extends n.default{constructor(e,t){super(e),this._handle=o.default.instance.load(t.model),this._handle.onLoaded=e=>{this._mesh=e.meshes[0],e.animationGroups.forEach((e=>{e.targetedAnimations.forEach((e=>{e.animation.enableBlending=!0,e.animation.blendingSpeed=.2}))}));const t=this.parent.getComponent(n.ComponentType.Animation);t&&t.setGroups(e.animationGroups)}}destroy(){super.destroy(),this._mesh.dispose(),this._mesh=null,this._handle.dispose()}get type(){return n.ComponentType.Render}update(){this._mesh&&(this._mesh.position.x=this.parent.position.x,this._mesh.position.z=this.parent.position.y,this._mesh.rotation=new i.Vector3(0,-this.parent.direction,0))}}t.default=r},3120:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.GameObjectType=void 0;const i=s(5412);var o;t.default=class{constructor(e,t){this._components=new Map,this._level=t,this._config=e,this._id=0,this._position=i.Vector2.Zero()}destroy(){this._components.forEach((e=>{e.destroy()})),this._components.clear()}get id(){return this._id}set id(e){this._id=e}get level(){return this._level}get config(){return this._config}get position(){return this._position}set position(e){this._position=e}get direction(){return 0}getComponent(e){return this._components.get(e)}addComponent(e){if(this._components.has(e.type))throw new Error(`Component of type ${e.type} already exists.`);this._components.set(e.type,e)}update(){this._components.forEach((e=>{e.update()}))}load(e){this._id=e.id,this._position=new i.Vector2(e.position.x,e.position.y)}save(){return{id:this._id,position:{x:this._position.x,y:this._position.y}}}},(o=t.GameObjectType||(t.GameObjectType={}))[o.Character=0]="Character"},4026:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Collider=void 0;const i=s(5863),o=s(671),n=s(871),r=s(3120);t.default=class{constructor(e,t){this._objects=new Map,this._size=e,this._subTiles=t,this._passableTiles=new Array(e.x*e.y*t*t)}getObject(e){return this._objects.get(e)}destroy(){this._objects.forEach((e=>{e.destroy()})),this._objects.clear()}load(e){let t=e.objects;for(let e=0;e<t.length;e++){let s=t[e],i=o.default.getCharacter(s.config),a=s.type,c=null;if(a!==r.GameObjectType.Character)throw new Error(`Unknown game object type: ${a}`);c=new n.default(i,this),c.load(s),this._objects.set(c.id,c)}}save(){let e=[];return this._objects.forEach((t=>{let s=t.save();s.type=t.type,s.config=t.config.id,e.push(s)})),{objects:e}}setPassableTiles(e){if(e.length!=this._size.x*this._size.y*this._subTiles*this._subTiles)throw new Error("Passable tiles array has wrong size");this._passableTiles=e}isPassableTile(e){const t=new i.Vector2(Math.floor(e.x*this._subTiles),Math.floor(e.y*this._subTiles));return!(t.x<0||t.y<0||t.x>=this._size.x*this._subTiles||t.y>=this._size.y*this._subTiles)&&this._passableTiles[t.x+t.y*this._size.x*this._subTiles]}update(){this._objects.forEach((e=>{e.update()}))}},t.Collider=class{constructor(e,t){this.start=e,this.end=t}}},5176:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class s{constructor(){this._tickNumber=0,this._startTimestamp=0}get tick(){return this._tickNumber}get timestamp(){return this._startTimestamp+Math.floor(this._tickNumber/s.TICKS_PER_SECOND)}}t.default=s,s.TICKS_PER_SECOND=60,s.TICK_DELTA_TIME=1/s.TICKS_PER_SECOND},4521:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0});const i=s(5863);class o{static init(e){e.onKeyboardObservable.add((e=>{e.type===i.KeyboardEventTypes.KEYDOWN?o._keysDown[e.event.key]=!0:o._keysDown[e.event.key]=!1}))}static isKeyDown(e){return o._keysDown[e]||!1}static onKeyDown(e){o._keysDown[e]=!0}}t.default=o,o._keysDown={}},3063:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MeshAsyncHandle=void 0;const i=s(5863);class o{constructor(){this._queue=[],this._nextId=0}load(e){const t=new n(this._nextId++,e);return this._queue.push(t),t}executeQueue(){if(0!==this._queue.length){console.log(`Loading ${this._queue.length} meshes...`);for(const e of this._queue)i.SceneLoader.ImportMeshAsync(null,"assets/",e.path).then((t=>{e.result=t}));this._queue=[]}}}t.default=o,o.instance=new o;class n{constructor(e,t){this._onLoaded=e=>{},this._onDisposed=()=>{},this._id=e,this._path=t,this._isLoaded=!1,this._isDisposed=!1}get id(){return this._id}get path(){return this._path}get mesh(){return this._result}get isLoaded(){return this._isLoaded}set result(e){if(this._isDisposed)for(const t of e.meshes)t.dispose();else this._result=e,this._isLoaded=!0,this._onLoaded(this._result)}get onLoaded(){return this._onLoaded}set onLoaded(e){this._onLoaded=e,this._isLoaded&&this._onLoaded(this._result)}get onDisposed(){return this._onDisposed}set onDisposed(e){this._onDisposed=e,this._isDisposed&&this._onDisposed()}dispose(){if(this._isDisposed=!0,this._result){for(const e of this._result.meshes)e.dispose();this._onDisposed(),this._result=null}}}t.MeshAsyncHandle=n},3184:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(o,n){function r(e){try{c(i.next(e))}catch(e){n(e)}}function a(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,a)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=s(5897),n=s(4521),r=s(3063);class a extends o.Scene{constructor(e){super(e)}init(){return i(this,void 0,void 0,(function*(){yield this.whenReadyAsync()}))}update(){this.render(),n.default.init(this),r.default.instance.executeQueue()}}t.default=a},3856:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(o,n){function r(e){try{c(i.next(e))}catch(e){n(e)}}function a(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,a)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=s(5863),n=s(8629),r=s(3120),a=s(4026),c=s(5176),l=s(4521),h=s(3184);class d extends h.default{constructor(e){super(e),this._logicTime=0,this._level=new a.default(d.WORLD_SIZE,d.WORLD_PRECISION),this.onDispose=()=>{this._level.destroy()}}init(){const e=Object.create(null,{init:{get:()=>super.init}});return i(this,void 0,void 0,(function*(){yield e.init.call(this),this._level.load({objects:[{type:r.GameObjectType.Character,config:1,id:1,position:d.WORLD_SIZE.scale(.5),direction:0}]}),this.createTerrain(),this._camera=new o.FlyCamera("camera",new o.Vector3(0,7,-10),this),new o.HemisphericLight("light",new o.Vector3(0,1,0),this)}))}createTerrain(){return i(this,void 0,void 0,(function*(){const e=(yield o.SceneLoader.ImportMeshAsync(null,"./assets/models/scenes/","world.glb",this)).meshes[0];e.position=new o.Vector3(5,-5.25,30).add(d.WORLD_CENTER_3D),e.scaling=new o.Vector3(5,5,5),e.bakeCurrentTransformIntoVertices();const t=o.MeshBuilder.CreateBox("fakeRect",{width:1/d.WORLD_PRECISION,height:2,depth:1/d.WORLD_PRECISION},this);t.isVisible=!1,t.showBoundingBox=!0;const s=e.getChildMeshes();for(let e=0;e<s.length;e++){const t=s[e];-1===t.name.indexOf("Circle")&&-1===t.name.indexOf("Plane")&&(t.showBoundingBox=!1)}const i=new Array(d.WORLD_SIZE.x*d.WORLD_SIZE.y*d.WORLD_PRECISION*d.WORLD_PRECISION);for(let e=0;e<i.length;e++)i[e]=!0;for(let e=0;e<s.length;e++){const n=s[e];if(-1!==n.name.indexOf("Circle")||-1!==n.name.indexOf("Plane"))continue;const r=n.getBoundingInfo(),a=r.boundingBox.minimumWorld,c=r.boundingBox.maximumWorld,l=new o.Vector2(Math.floor(a.x*d.WORLD_PRECISION),Math.floor(a.z*d.WORLD_PRECISION)),h=new o.Vector2(Math.ceil(c.x*d.WORLD_PRECISION),Math.ceil(c.z*d.WORLD_PRECISION));for(let e=l.x;e<h.x;e++)for(let s=l.y;s<h.y;s++){if(e<0||e>=d.WORLD_SIZE.x*d.WORLD_PRECISION||s<0||s>=d.WORLD_SIZE.y*d.WORLD_PRECISION)continue;const r=e+s*d.WORLD_SIZE.x*d.WORLD_PRECISION;t.position=new o.Vector3(e/d.WORLD_PRECISION,1,s/d.WORLD_PRECISION),t.computeWorldMatrix(!0),i[r]=!n.intersectsMesh(t,!0)}}t.dispose(),this._level.setPassableTiles(i)}))}updateLogic(){const e=this.getEngine().getDeltaTime()/1e3;for(this._logicTime+=e;this._logicTime>c.default.TICK_DELTA_TIME;)this._level.update(),this._logicTime-=c.default.TICK_DELTA_TIME}updateCamera(){const e=this._level.getObject(1),t=new o.Vector3(e.position.x,0,e.position.y),s=this._camera.position,i=t.add(d.CAMERA_OFFSET);this._camera.position=o.Vector3.Lerp(s,i,d.CAMERA_SPEED*c.default.TICK_DELTA_TIME),this._camera.setTarget(t)}update(){super.update();const e=this._level.getObject(1).getComponent(n.ComponentType.Movement);e.input.axis.x=l.default.isKeyDown("d")?1:l.default.isKeyDown("q")?-1:0,e.input.axis.y=l.default.isKeyDown("z")?1:l.default.isKeyDown("s")?-1:0,this.updateLogic(),this.updateCamera(),this.render()}}t.default=d,d.CAMERA_SPEED=10,d.CAMERA_OFFSET=new o.Vector3(0,7,-10),d.WORLD_PRECISION=16,d.WORLD_SIZE=new o.Vector2(50,50),d.WORLD_CENTER_3D=new o.Vector3(d.WORLD_SIZE.x/2,0,d.WORLD_SIZE.y/2)},7872:e=>{e.exports=JSON.parse('{"characters":[{"id":1,"name":"Character Test","movement":{"speed":5,"acceleration":10},"render":{"model":"models/characters/shriley.glb"}}]}')}},s={};function i(e){var o=s[e];if(void 0!==o)return o.exports;var n=s[e]={exports:{}};return t[e].call(n.exports,n,n.exports,i),n.exports}i.m=t,e=[],i.O=(t,s,o,n)=>{if(!s){var r=1/0;for(h=0;h<e.length;h++){for(var[s,o,n]=e[h],a=!0,c=0;c<s.length;c++)(!1&n||r>=n)&&Object.keys(i.O).every((e=>i.O[e](s[c])))?s.splice(c--,1):(a=!1,n<r&&(r=n));if(a){e.splice(h--,1);var l=o();void 0!==l&&(t=l)}}return t}n=n||0;for(var h=e.length;h>0&&e[h-1][2]>n;h--)e[h]=e[h-1];e[h]=[s,o,n]},i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e={179:0};i.O.j=t=>0===e[t];var t=(t,s)=>{var o,n,[r,a,c]=s,l=0;if(r.some((t=>0!==e[t]))){for(o in a)i.o(a,o)&&(i.m[o]=a[o]);if(c)var h=c(i)}for(t&&t(s);l<r.length;l++)n=r[l],i.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return i.O(h)},s=self.webpackChunknakama_game=self.webpackChunknakama_game||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var o=i.O(void 0,[520],(()=>i(3607)));o=i.O(o)})();